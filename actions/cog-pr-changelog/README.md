# Cocogitto PR Changelog Action

This action generates a changelog using [cocogitto](https://github.com/cocogitto/cocogitto) and posts it as a comment to a Pull Request. If a changelog comment already exists, it updates that comment.

## Features

- üìã Generates changelog from conventional commits using cocogitto
- üè∑Ô∏è Determines next version automatically based on conventional commits
- üí¨ Posts changelog as PR comment with version information
- üé® Customizable comment header and footer

## Usage

### Basic Usage

```yaml
name: PR Changelog
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Generate and post changelog
        uses: ./actions/cog-pr-changelog
        with:
          forgejo_token: ${{ secrets.GITHUB_TOKEN }}
```

### Advanced Usage

```yaml
name: PR Changelog
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Generate and post changelog
        uses: ./actions/cog-pr-changelog
        with:
          # Changelog generation options
          changelog_pattern: "origin/${{ env.GITHUB_BASE_REF }}..HEAD"
          changelog_template: "remote"
          changelog_remote: "https://github.com/owner/repo"
          changelog_owner: "owner"
          changelog_repository: "repo"

          # Comment customization
          comment_header: "## üöÄ What's Changed"
          comment_footer: "*Automatically generated changelog*"

          # Forgejo configuration
          forgejo_token: ${{ secrets.GITHUB_TOKEN }}
          forgejo_server_url: ${{ env.GITHUB_SERVER_URL }}
```

## Inputs

### Changelog Generation Options

| Input                  | Description                                                                                                    | Required | Default                                   |
| ---------------------- | -------------------------------------------------------------------------------------------------------------- | -------- | ----------------------------------------- |
| `changelog_pattern`    | Generate the changelog in the given spec range (e.g., "HEAD~10..HEAD", "v1.0.0..HEAD")                         | No       | `origin/${{ env.GITHUB_BASE_REF }}..HEAD` |
| `changelog_template`   | Template to use for changelog generation. Values: "remote", "full_hash", "default", or path to custom template | No       | `default`                                 |
| `changelog_remote`     | URL to use during template generation                                                                          | No       |                                           |
| `changelog_owner`      | Repository owner to use during template generation                                                             | No       |                                           |
| `changelog_repository` | Name of the repository used during template generation                                                         | No       |                                           |

### Comment Configuration

| Input            | Description                           | Required | Default                                                              |
| ---------------- | ------------------------------------- | -------- | -------------------------------------------------------------------- |
| `comment_header` | Header text for the changelog comment | No       | `## üìã Changelog`                                                    |
| `comment_footer` | Footer text for the changelog comment | No       | `*Generated by [cocogitto](https://github.com/cocogitto/cocogitto)*` |

### Forgejo/Git Configuration

| Input                 | Description                               | Required | Default                                                                              |
| --------------------- | ----------------------------------------- | -------- | ------------------------------------------------------------------------------------ |
| `forgejo_server_url`  | Forgejo server URL for API calls          | No       | `${{ env.GITHUB_SERVER_URL }}`                                                       |
| `forgejo_token`       | Forgejo API token                         | No       | `${{ env.GITHUB_TOKEN }}`                                                            |
| `forgejo_curl_source` | Where to download the forgejo-curl script | No       | `https://git.h.oluflorenzen.de/mirrors/forgejo-curl/raw/branch/main/forgejo-curl.sh` |

## Outputs

| Output            | Description                                     |
| ----------------- | ----------------------------------------------- |
| `changelog`       | Generated changelog content                     |
| `current_version` | Current version determined by cocogitto         |
| `next_version`    | Next version that would be created by cocogitto |
| `comment_id`      | ID of the created or updated comment            |
| `comment_url`     | URL of the created or updated comment           |

## How It Works

1. **Checkout**: Fetches the repository with sufficient history for changelog generation
2. **Install cocogitto**: Installs the cocogitto CLI tool
3. **Determine next version**: Uses `cog bump --auto --dry-run` to determine what the next version would be based on conventional commits
4. **Generate changelog**: Uses cocogitto to generate a changelog based on conventional commits
5. **Install helper**: Downloads and sets up the forgejo-curl helper script
6. **Post/Update comment**:
   - Creates a comment body that includes both version information and changelog
   - Checks if a changelog comment already exists on the PR
   - If found, updates the existing comment
   - If not found, creates a new comment
7. **Handle non-PR events**: For non-PR events, displays the changelog in the action log

## Requirements

- Repository must use [conventional commits](https://www.conventionalcommits.org/)
- Action must run on pull request events to post comments
- Requires `GITHUB_TOKEN` or equivalent Forgejo token with repository access

## Example Comment Output

```markdown
## üìã Changelog

**üì¶ Version Information**

- Current version: `v1.2.0`
- Next version: `v1.3.0`

### Features

- feat: add new user authentication system
- feat(ui): implement dark mode toggle

### Bug Fixes

- fix: resolve memory leak in data processing
- fix(api): handle edge case in user validation

### Documentation

- docs: update API documentation
- docs: add contributing guidelines

_Generated by [cocogitto](https://github.com/cocogitto/cocogitto)_
```

## License

This action is licensed under the MIT License.
